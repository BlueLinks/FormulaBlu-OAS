name: Build and Test OAS Specifications

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]
    workflow_dispatch:

permissions:
    contents: read

jobs:
    build-and-test:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"
                  cache: "npm"

            - name: Install dependencies
              run: |
                  echo "ğŸ“¦ Installing dependencies..."
                  npm install
                  echo "âœ… Dependencies installed"

            - name: Install TypeSpec compiler
              run: |
                  echo "ğŸ”§ Installing TypeSpec compiler..."
                  npm install -g @typespec/compiler
                  echo "âœ… TypeSpec compiler installed"

            - name: Validate TypeSpec files
              run: |
                  echo "ğŸ” Validating TypeSpec files..."

                  # Check if TypeSpec files exist and are valid
                  for api in drivers-api teams-api tracks-api races-api seasons-api events-api results-api; do
                    if [ -d "$api" ]; then
                      echo "ğŸ“ Validating $api..."
                      if [ -f "$api/main.tsp" ]; then
                        echo "  âœ“ main.tsp exists"
                      else
                        echo "  âŒ main.tsp missing"
                        exit 1
                      fi
                      if [ -f "$api/models.tsp" ]; then
                        echo "  âœ“ models.tsp exists"
                      else
                        echo "  âŒ models.tsp missing"
                        exit 1
                      fi
                      if [ -f "$api/requests.tsp" ]; then
                        echo "  âœ“ requests.tsp exists"
                      else
                        echo "  âŒ requests.tsp missing"
                        exit 1
                      fi
                      if [ -f "$api/responses.tsp" ]; then
                        echo "  âœ“ responses.tsp exists"
                      else
                        echo "  âŒ responses.tsp missing"
                        exit 1
                      fi
                    else
                      echo "âš ï¸  $api directory missing"
                    fi
                  done

                  # Check shared files
                  echo "ğŸ“ Validating shared files..."
                  for file in shared/models.tsp shared/parameters.tsp shared/responses.tsp shared/versioning.tsp shared/validation.tsp; do
                    if [ -f "$file" ]; then
                      echo "  âœ“ $file exists"
                    else
                      echo "  âŒ $file missing"
                      exit 1
                    fi
                  done

                  echo "âœ… All TypeSpec files validated"

            - name: Test TypeSpec compilation
              run: |
                  echo "ğŸ”¨ Testing TypeSpec compilation..."

                  # Test compilation of each API
                  for api in drivers-api teams-api tracks-api races-api seasons-api events-api results-api; do
                    if [ -d "$api" ]; then
                      echo "ğŸ“ Compiling $api..."
                      if npx tsp compile "$api/main.tsp" --emit @typespec/openapi3 --no-emit; then
                        echo "  âœ… $api compiled successfully"
                      else
                        echo "  âŒ $api compilation failed"
                        exit 1
                      fi
                    fi
                  done

                  echo "âœ… All APIs compiled successfully"

            - name: Generate OpenAPI specifications
              run: |
                  echo "ğŸ“„ Generating OpenAPI specifications..."

                  # Create generated directory
                  mkdir -p generated

                  # Generate OpenAPI specs for each API
                  for api in drivers-api teams-api tracks-api races-api seasons-api events-api results-api; do
                    if [ -d "$api" ]; then
                      echo "ğŸ“ Generating OpenAPI spec for $api..."
                      if npx tsp compile "$api/main.tsp" --emit @typespec/openapi3 --output-dir generated; then
                        echo "  âœ… $api OpenAPI spec generated"
                      else
                        echo "  âŒ $api OpenAPI spec generation failed"
                        exit 1
                      fi
                    fi
                  done

                  # List generated files
                  echo "ğŸ“‹ Generated files:"
                  ls -la generated/

                  echo "âœ… OpenAPI specifications generated"

            - name: Validate OpenAPI specifications
              run: |
                  echo "ğŸ” Validating OpenAPI specifications..."

                  # Install swagger-codegen for validation
                  npm install -g @apidevtools/swagger-parser

                  # Validate each generated OpenAPI spec
                  for api in drivers-api teams-api tracks-api races-api seasons-api events-api results-api; do
                    if [ -f "generated/$api.yaml" ]; then
                      echo "ğŸ“ Validating $api.yaml..."
                      if npx swagger-parser validate "generated/$api.yaml"; then
                        echo "  âœ… $api.yaml is valid"
                      else
                        echo "  âŒ $api.yaml is invalid"
                        exit 1
                      fi
                    else
                      echo "  âš ï¸  $api.yaml not found"
                    fi
                  done

                  echo "âœ… All OpenAPI specifications are valid"

            - name: Test SDK generation
              run: |
                  echo "ğŸ”§ Testing SDK generation..."

                  # Test SDK generation for one API (drivers-api)
                  if [ -f "generated/drivers-api.yaml" ]; then
                    echo "ğŸ“ Testing SDK generation for drivers-api..."
                    
                    # Create test SDK directory
                    mkdir -p test-sdks
                    
                    # Test Java SDK generation
                    echo "  ğŸ”¨ Testing Java SDK generation..."
                    if npx @openapitools/openapi-generator-cli generate \
                      -i "generated/drivers-api.yaml" \
                      -g java \
                      -o "test-sdks/java-drivers-api" \
                      --package-name "com.formulablu.drivers.api" \
                      --api-package "com.formulablu.drivers.api" \
                      --model-package "com.formulablu.drivers.model" \
                      --additional-properties=dateLibrary=java8,library=feign; then
                      echo "    âœ… Java SDK generated successfully"
                    else
                      echo "    âŒ Java SDK generation failed"
                      exit 1
                    fi
                    
                    # Test TypeScript SDK generation
                    echo "  ğŸ”¨ Testing TypeScript SDK generation..."
                    if npx @openapitools/openapi-generator-cli generate \
                      -i "generated/drivers-api.yaml" \
                      -g typescript-fetch \
                      -o "test-sdks/typescript-drivers-api" \
                      --package-name "@formulablu/drivers-api" \
                      --additional-properties=supportsES6=true,typescriptThreePlus=true; then
                      echo "    âœ… TypeScript SDK generated successfully"
                    else
                      echo "    âŒ TypeScript SDK generation failed"
                      exit 1
                    fi
                    
                    echo "âœ… SDK generation test completed"
                  else
                    echo "âš ï¸  drivers-api.yaml not found, skipping SDK generation test"
                  fi

            - name: Test documentation generation
              run: |
                  echo "ğŸ“š Testing documentation generation..."

                  # Test documentation generation script
                  if [ -f "scripts/generate-docs.js" ]; then
                    echo "ğŸ“ Testing documentation generation script..."
                    if node scripts/generate-docs.js; then
                      echo "  âœ… Documentation generation script works"
                    else
                      echo "  âŒ Documentation generation script failed"
                      exit 1
                    fi
                  else
                    echo "  âš ï¸  Documentation generation script not found"
                  fi

                  echo "âœ… Documentation generation test completed"

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: oas-build-artifacts
                  path: |
                      generated/
                      test-sdks/
                  retention-days: 7

            - name: Build Summary
              run: |
                  echo "ğŸ‰ Build Summary"
                  echo "================"
                  echo "âœ… Dependencies installed"
                  echo "âœ… TypeSpec files validated"
                  echo "âœ… TypeSpec compilation successful"
                  echo "âœ… OpenAPI specifications generated"
                  echo "âœ… OpenAPI specifications validated"
                  echo "âœ… SDK generation tested"
                  echo "âœ… Documentation generation tested"
                  echo ""
                  echo "ğŸ“Š Generated Files:"
                  if [ -d "generated" ]; then
                    ls -la generated/
                  fi
                  echo ""
                  echo "ğŸ”§ Test SDKs:"
                  if [ -d "test-sdks" ]; then
                    ls -la test-sdks/
                  fi
