name: Build and Test OAS Specifications

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]
    workflow_dispatch:

permissions:
    contents: read

jobs:
    build-and-test:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"

            - name: Install dependencies
              run: |
                  echo "ğŸ“¦ Installing dependencies..."
                  npm install
                  echo "âœ… Dependencies installed"

            - name: Validate TypeSpec files
              run: |
                  echo "ğŸ” Validating TypeSpec files..."

                  # Check if TypeSpec files exist and are valid
                  for api in drivers-api teams-api tracks-api races-api seasons-api events-api results-api; do
                    if [ -d "$api" ]; then
                      echo "ğŸ“ Validating $api..."
                      if [ -f "$api/main.tsp" ]; then
                        echo "  âœ“ main.tsp exists"
                      else
                        echo "  âŒ main.tsp missing"
                        exit 1
                      fi
                    else
                      echo "âš ï¸  $api directory missing"
                    fi
                  done

                  # Check shared files
                  echo "ğŸ“ Validating shared files..."
                  for file in shared/models.tsp shared/parameters.tsp shared/responses.tsp; do
                    if [ -f "$file" ]; then
                      echo "  âœ“ $file exists"
                    else
                      echo "  âŒ $file missing"
                      exit 1
                    fi
                  done

                  echo "âœ… All TypeSpec files validated"

            - name: Test TypeSpec compilation
              run: |
                  echo "ğŸ”¨ Testing TypeSpec compilation..."
                  npm run build
                  echo "âœ… All APIs compiled successfully"

            - name: Generate OpenAPI specifications
              run: |
                  echo "ğŸ“„ Generating OpenAPI specifications..."
                  npm run build:apis

                  # List generated files
                  echo "ğŸ“‹ Generated files:"
                  ls -la generated/apis/

                  echo "âœ… OpenAPI specifications generated"

            - name: Validate OpenAPI specifications
              run: |
                  echo "ğŸ” Validating OpenAPI specifications..."

                  # Install swagger-codegen for validation
                  npm install -g @apidevtools/swagger-parser

                  # Validate each generated OpenAPI spec
                  for api in drivers-api teams-api tracks-api races-api seasons-api events-api results-api; do
                    if [ -f "generated/apis/$api.yaml" ]; then
                      echo "ğŸ“ Validating $api.yaml..."
                      if npx swagger-parser validate "generated/apis/$api.yaml"; then
                        echo "  âœ… $api.yaml is valid"
                      else
                        echo "  âŒ $api.yaml is invalid"
                        exit 1
                      fi
                    else
                      echo "  âš ï¸  $api.yaml not found"
                    fi
                  done

                  echo "âœ… All OpenAPI specifications are valid"

            - name: Test SDK generation
              run: |
                  echo "ğŸ”§ Testing SDK generation..."
                  npm run generate:sdks
                  echo "âœ… SDK generation test completed"

            - name: Test documentation generation
              run: |
                  echo "ğŸ“š Testing documentation generation..."
                  npm run generate:docs
                  echo "âœ… Documentation generation test completed"

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: oas-build-artifacts
                  path: |
                      generated/
                      docs/
                      sdks/
                  retention-days: 7

            - name: Build Summary
              run: |
                  echo "ğŸ‰ Build Summary"
                  echo "================"
                  echo "âœ… Dependencies installed"
                  echo "âœ… TypeSpec files validated"
                  echo "âœ… TypeSpec compilation successful"
                  echo "âœ… OpenAPI specifications generated"
                  echo "âœ… OpenAPI specifications validated"
                  echo "âœ… SDK generation tested"
                  echo "âœ… Documentation generation tested"
                  echo ""
                  echo "ğŸ“Š Generated Files:"
                  if [ -d "generated/apis" ]; then
                    ls -la generated/apis/
                  fi
                  echo ""
                  echo "ğŸ“š Documentation:"
                  if [ -d "docs" ]; then
                    ls -la docs/
                  fi
                  echo ""
                  echo "ğŸ”§ SDKs:"
                  if [ -d "sdks" ]; then
                    ls -la sdks/
                  fi
